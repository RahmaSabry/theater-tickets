<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Scan Ticket</title>
  <script src="https://unpkg.com/html5-qrcode"></script> 
</head>
<body>
  <h1>üì∏ Scan Ticket</h1>

  <button id="startCamera">Start Camera</button>
  <div id="reader" style="width:500px; margin-top:20px;"></div>

  <div id="result" style="margin-top:20px;"></div>

  <script>
    const startCameraBtn = document.getElementById("startCamera");
    const resultDiv = document.getElementById("result");
    let html5QrcodeScanner;

    startCameraBtn.addEventListener("click", () => {
      if (html5QrcodeScanner) return;

      html5QrcodeScanner = new Html5Qrcode("reader");
      html5QrcodeScanner.start(
        { facingMode: "environment" },
        {
          fps: 10,
          qrbox: 250
        },
        async (decodedText, decodedResult) => {
          // QR scanned successfully
          const ticketId = decodedText.split("/").pop(); 
          try {
            const res = await fetch(`/ticket/scan/${ticketId}`);
            const data = await res.json();

            if (data.error) {
              resultDiv.innerHTML = `<p style="color:red;">‚ùå ${data.error}</p>`;
            } else {
              let color = data.status === "valid" ? "green" : "red";
              resultDiv.innerHTML = `
                <p><b>User:</b> ${data.user}</p>
                <p><b>Price:</b> ${data.price}</p>
                <p><b>Status:</b> <span style="color:${color}">${data.status}</span></p>
              `;
            }
          } catch (err) {
            console.error(err);
            resultDiv.innerHTML = `<p style="color:red;">Error scanning ticket</p>`;
          }

          html5QrcodeScanner.stop();
        },
        (errorMessage) => {
          // error scanning QR
          console.warn(errorMessage);
        }
      );
    });
  </script>
</body>
</html>
